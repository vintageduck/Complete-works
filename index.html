<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Curator's Study</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        serif: ['"Crimson Pro"', 'Georgia', 'Cambria', '"Times New Roman"', 'Times', 'serif'],
                        sans: ['"Inter"', 'system-ui', 'sans-serif'],
                    },
                    colors: {
                        paper: '#f7f5e8', // Soft warm white
                        ink: '#2d2d2d',   // Soft black
                        sepia: {
                            100: '#f4ecd8',
                            900: '#5b4636',
                        }
                    }
                }
            }
        }
    </script>

    <!-- Google Fonts: Crimson Pro for that classic book feel -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,600;1,400&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">

    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- EPUB.js Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>

    <style>
        /* Custom Scrollbar for the library view */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #475569; 
        }

        /* Reader Area Transitions */
        #viewer iframe {
            transition: opacity 0.3s ease;
        }
        
        /* Loader Animation */
        .spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #4f46e5;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Hide standard file input */
        input[type="file"] {
            display: none;
        }
    </style>
</head>
<body class="bg-paper text-ink transition-colors duration-300 font-serif h-screen overflow-hidden flex flex-col selection:bg-amber-200 selection:text-amber-900">

    <!-- APP CONTAINER -->
    <div id="app" class="flex flex-col h-full relative">
        
        <!-- HEADER -->
        <header class="flex-none h-16 border-b border-stone-200/50 dark:border-stone-700/50 flex items-center justify-between px-6 bg-white/50 dark:bg-stone-900/50 backdrop-blur-md z-20">
            <div class="flex items-center gap-3">
                <i data-lucide="library" class="w-6 h-6 text-stone-600 dark:text-stone-400"></i>
                <h1 class="text-xl font-semibold tracking-tight text-stone-800 dark:text-stone-200 font-sans">The Curator's Study</h1>
            </div>

            <div class="flex items-center gap-4">
                <button onclick="toggleTheme()" class="p-2 hover:bg-stone-200 dark:hover:bg-stone-800 rounded-full transition-colors" title="Toggle Dark Mode">
                    <i data-lucide="moon" class="w-5 h-5 text-stone-600 dark:text-stone-400"></i>
                </button>
                <label for="file-upload" class="cursor-pointer px-4 py-1.5 bg-stone-800 hover:bg-stone-700 dark:bg-stone-200 dark:hover:bg-white text-stone-100 dark:text-stone-900 rounded-full text-sm font-sans font-medium transition-all shadow-sm">
                    Open EPUB
                </label>
                <input id="file-upload" type="file" accept=".epub" onchange="handleFileUpload(event)">
            </div>
        </header>

        <!-- MAIN CONTENT AREA -->
        <main class="flex-1 relative overflow-hidden">
            
            <!-- VIEW: WELCOME / EMPTY STATE -->
            <div id="view-welcome" class="absolute inset-0 flex flex-col items-center justify-center p-8 text-center bg-paper dark:bg-stone-950 transition-colors z-10">
                <div class="max-w-md space-y-6">
                    <div class="w-20 h-20 bg-stone-200 dark:bg-stone-800 rounded-full flex items-center justify-center mx-auto mb-6">
                        <i data-lucide="book-open" class="w-10 h-10 text-stone-500"></i>
                    </div>
                    <h2 class="text-3xl font-serif text-stone-800 dark:text-stone-100">Your Digital Collection</h2>
                    <p class="text-stone-600 dark:text-stone-400 font-sans leading-relaxed">
                        Drag and drop a "Complete Works" EPUB file here to organize it into a beautiful, readable library.
                    </p>
                    <div class="pt-8">
                        <p class="text-xs text-stone-400 font-sans uppercase tracking-widest">Supports Standard EPUB Format</p>
                    </div>
                </div>
            </div>

            <!-- VIEW: LIBRARY SHELF -->
            <div id="view-library" class="absolute inset-0 bg-stone-50 dark:bg-stone-900 overflow-y-auto p-8 hidden opacity-0 transition-opacity duration-500 z-10">
                <div class="max-w-7xl mx-auto">
                    <div class="flex items-center justify-between mb-8">
                        <h2 id="library-title" class="text-2xl font-serif text-stone-800 dark:text-stone-100">Library Content</h2>
                        <div class="flex gap-2 text-sm font-sans">
                            <span id="book-count" class="bg-stone-200 dark:bg-stone-800 px-3 py-1 rounded-full text-stone-600 dark:text-stone-300">0 Works</span>
                        </div>
                    </div>

                    <!-- Filter Tags (Dynamic) -->
                    <div id="filter-container" class="flex flex-wrap gap-2 mb-8 font-sans text-sm">
                        <!-- Pills injected via JS -->
                    </div>

                    <!-- Books Grid -->
                    <div id="books-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 pb-20">
                        <!-- Cards injected via JS -->
                    </div>
                </div>
            </div>

            <!-- VIEW: READER -->
            <div id="view-reader" class="absolute inset-0 bg-white dark:bg-stone-950 hidden z-30 flex flex-col">
                
                <!-- Reader Toolbar -->
                <div class="h-14 border-b border-stone-100 dark:border-stone-800 flex items-center justify-between px-4 bg-white dark:bg-stone-950">
                    <button onclick="closeReader()" class="flex items-center gap-2 text-stone-500 hover:text-stone-800 dark:hover:text-stone-200 transition-colors font-sans text-sm">
                        <i data-lucide="arrow-left" class="w-4 h-4"></i>
                        Back to Shelf
                    </button>
                    
                    <h3 id="reader-title" class="font-serif text-stone-800 dark:text-stone-200 truncate max-w-md text-center">Untitled</h3>

                    <div class="flex items-center gap-1">
                        <!-- Appearance Menu Trigger -->
                        <button onclick="toggleSettings()" class="p-2 text-stone-500 hover:bg-stone-100 dark:hover:bg-stone-800 rounded-md">
                            <i data-lucide="type" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>

                <!-- Settings Popover -->
                <div id="settings-popover" class="absolute top-16 right-4 w-64 bg-white dark:bg-stone-900 shadow-xl border border-stone-200 dark:border-stone-700 rounded-xl p-4 hidden z-50 font-sans">
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs font-semibold text-stone-400 uppercase tracking-wider mb-2 block">Text Size</label>
                            <div class="flex items-center gap-3">
                                <button onclick="changeFontSize(-10)" class="p-1 hover:bg-stone-100 dark:hover:bg-stone-800 rounded"><i data-lucide="minus" class="w-4 h-4"></i></button>
                                <div class="flex-1 h-1 bg-stone-200 dark:bg-stone-700 rounded-full overflow-hidden">
                                    <div id="font-size-indicator" class="h-full bg-stone-800 dark:bg-stone-200 w-1/2"></div>
                                </div>
                                <button onclick="changeFontSize(10)" class="p-1 hover:bg-stone-100 dark:hover:bg-stone-800 rounded"><i data-lucide="plus" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                        <div>
                            <label class="text-xs font-semibold text-stone-400 uppercase tracking-wider mb-2 block">Theme</label>
                            <div class="grid grid-cols-3 gap-2">
                                <button onclick="setReaderTheme('light')" class="h-8 rounded border border-stone-200 bg-white"></button>
                                <button onclick="setReaderTheme('sepia')" class="h-8 rounded border border-stone-200 bg-[#f4ecd8]"></button>
                                <button onclick="setReaderTheme('dark')" class="h-8 rounded border border-stone-700 bg-[#2d2d2d]"></button>
                            </div>
                        </div>
                        <div>
                            <label class="text-xs font-semibold text-stone-400 uppercase tracking-wider mb-2 block">Font</label>
                            <select id="font-select" onchange="changeFontFamily(this.value)" class="w-full text-sm bg-stone-50 dark:bg-stone-800 border-none rounded px-2 py-1">
                                <option value="'Crimson Pro', serif">Crimson Pro (Serif)</option>
                                <option value="Georgia, serif">Georgia</option>
                                <option value="'Inter', sans-serif">Inter (Sans)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Epub Container -->
                <div class="flex-1 relative group">
                    <div id="viewer" class="w-full h-full"></div>
                    
                    <!-- Navigation Overlay (Hover) -->
                    <button id="prev-btn" onclick="prevPage()" class="absolute left-0 top-0 bottom-0 w-16 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity hover:bg-stone-100/10 dark:hover:bg-white/5">
                        <i data-lucide="chevron-left" class="w-8 h-8 text-stone-400"></i>
                    </button>
                    <button id="next-btn" onclick="nextPage()" class="absolute right-0 top-0 bottom-0 w-16 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity hover:bg-stone-100/10 dark:hover:bg-white/5">
                        <i data-lucide="chevron-right" class="w-8 h-8 text-stone-400"></i>
                    </button>

                    <!-- Loading Indicator for Chapters -->
                    <div id="chapter-loader" class="absolute inset-0 flex items-center justify-center bg-white/80 dark:bg-stone-950/80 z-40 hidden">
                        <div class="spinner"></div>
                    </div>
                </div>
                
                <!-- Progress Bar -->
                <div class="h-8 border-t border-stone-100 dark:border-stone-800 flex items-center justify-center bg-white dark:bg-stone-950 text-xs text-stone-400 font-sans">
                    <span id="page-location">Calculating...</span>
                </div>
            </div>

            <!-- Loading Modal -->
            <div id="loading-overlay" class="absolute inset-0 bg-white/90 dark:bg-black/90 z-50 flex flex-col items-center justify-center hidden">
                <div class="spinner mb-4"></div>
                <p id="loading-text" class="text-stone-600 dark:text-stone-300 font-sans animate-pulse">Parsing Library...</p>
            </div>

        </main>
    </div>

    <!-- MAIN LOGIC -->
    <script>
        // --- ICONS ---
        lucide.createIcons();

        // --- STATE ---
        let book = null;
        let rendition = null;
        let libraryData = []; // Flattened list of "books" within the epub
        let currentSectionUrl = null;
        let themes = {
            light: { body: { color: '#2d2d2d', background: '#ffffff' }, p: { 'font-size': '18px', 'line-height': '1.6' } },
            sepia: { body: { color: '#5b4636', background: '#f4ecd8' }, p: { 'font-size': '18px', 'line-height': '1.6' } },
            dark:  { body: { color: '#d1d5db', background: '#1c1917' }, p: { 'font-size': '18px', 'line-height': '1.6' } }
        };
        let currentTheme = 'light';
        let currentFontSize = 100; // Percentage
        let currentFontFamily = "'Crimson Pro', serif";

        // --- DRAG & DROP HANDLERS ---
        const app = document.getElementById('app');
        app.addEventListener('dragover', (e) => e.preventDefault());
        app.addEventListener('drop', (e) => {
            e.preventDefault();
            if (e.dataTransfer.files.length) {
                const file = e.dataTransfer.files[0];
                if (file.name.endsWith('.epub')) {
                    loadEpub(file);
                } else {
                    alert('Please drop an .epub file');
                }
            }
        });

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) loadEpub(file);
        }

        // --- EPUB LOADING & PARSING ---
        function loadEpub(file) {
            showLoading(true, "Opening Volume...");
            
            // Initialize ePub
            const reader = new FileReader();
            reader.onload = function(e) {
                const bookData = e.target.result;
                book = ePub(bookData);

                book.ready.then(() => {
                    // Extract Navigation (TOC)
                    return book.loaded.navigation;
                }).then((nav) => {
                    parseLibraryFromTOC(nav);
                    showLoading(false);
                    switchView('library');
                }).catch(err => {
                    console.error(err);
                    alert("Error parsing EPUB. Is it a valid file?");
                    showLoading(false);
                });
            };
            reader.readAsArrayBuffer(file);
        }

        // --- LIBRARY PARSING LOGIC ---
        // This is the "Smart" part. It tries to figure out structure.
        function parseLibraryFromTOC(nav) {
            libraryData = [];
            const toc = nav.toc;

            // Helper to generate a pastel color from a string (category name)
            const stringToColor = (str) => {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    hash = str.charCodeAt(i) + ((hash << 5) - hash);
                }
                const h = Math.abs(hash) % 360;
                return `hsl(${h}, 25%, 85%)`; // Pastel HSL
            };

            const stringToDarkColor = (str) => {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    hash = str.charCodeAt(i) + ((hash << 5) - hash);
                }
                const h = Math.abs(hash) % 360;
                return `hsl(${h}, 30%, 25%)`; // Dark Pastel HSL
            };

            // Recursive function to find "books"
            // Strategy: 
            // 1. If a node has subitems, and those subitems have NO subitems, the node is likely a Book and subitems are chapters.
            // 2. If a node has subitems that HAVE subitems, the node is likely a Category (e.g. "Novels").
            
            function traverse(items, parentCategory = "General") {
                items.forEach(item => {
                    const hasChildren = item.subitems && item.subitems.length > 0;
                    
                    if (!hasChildren) {
                        // Leaf node at top level? Treat as Short Story/Essay
                        libraryData.push({
                            title: item.label.trim(),
                            href: item.href,
                            category: parentCategory,
                            isBook: false 
                        });
                    } else {
                        // Check grandchildren
                        const hasGrandchildren = item.subitems.some(sub => sub.subitems && sub.subitems.length > 0);

                        if (hasGrandchildren) {
                            // This is a Category (e.g. "Novels")
                            traverse(item.subitems, item.label.trim());
                        } else {
                            // This is a Book (e.g. "Pride and Prejudice") containing chapters
                            libraryData.push({
                                title: item.label.trim(),
                                href: item.href, // Link to first chapter/title page
                                category: parentCategory,
                                isBook: true,
                                chapters: item.subitems // Store chapters if we want deeper nav later
                            });
                        }
                    }
                });
            }

            traverse(toc);
            renderLibrary();
        }

        // --- RENDER LIBRARY ---
        function renderLibrary() {
            const grid = document.getElementById('books-grid');
            const count = document.getElementById('book-count');
            const filterContainer = document.getElementById('filter-container');
            
            grid.innerHTML = '';
            filterContainer.innerHTML = '';
            count.innerText = `${libraryData.length} Works`;

            // Unique Categories
            const categories = [...new Set(libraryData.map(item => item.category))];
            
            // Render Filters
            categories.forEach(cat => {
                const pill = document.createElement('button');
                pill.className = `px-3 py-1 rounded-full text-xs font-medium bg-stone-100 hover:bg-stone-200 dark:bg-stone-800 dark:hover:bg-stone-700 text-stone-600 dark:text-stone-300 transition-colors border border-stone-200 dark:border-stone-700`;
                pill.innerText = cat;
                pill.onclick = () => filterLibrary(cat);
                filterContainer.appendChild(pill);
            });

            // Add "All" filter
            const allPill = document.createElement('button');
            allPill.className = `px-3 py-1 rounded-full text-xs font-medium bg-stone-800 text-white dark:bg-white dark:text-black transition-colors shadow-sm`;
            allPill.innerText = "All Works";
            allPill.onclick = () => filterLibrary('all');
            filterContainer.prepend(allPill);

            // Render Cards
            libraryData.forEach(item => {
                createBookCard(item, grid);
            });
        }

        function filterLibrary(category) {
            const grid = document.getElementById('books-grid');
            grid.innerHTML = '';
            
            const filtered = category === 'all' 
                ? libraryData 
                : libraryData.filter(i => i.category === category);

            filtered.forEach(item => createBookCard(item, grid));
        }

        function createBookCard(item, container) {
            // Deterministic color generation based on category name
            const getColors = (str) => {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                     hash = str.charCodeAt(i) + ((hash << 5) - hash);
                }
                const hue = Math.abs(hash) % 360;
                return {
                    light: `hsl(${hue}, 30%, 90%)`,
                    dark: `hsl(${hue}, 20%, 20%)`,
                    border: `hsl(${hue}, 20%, 80%)`,
                    text: `hsl(${hue}, 40%, 30%)`,
                    darkText: `hsl(${hue}, 40%, 80%)`
                };
            };

            const colors = getColors(item.category);

            const card = document.createElement('div');
            card.className = "group relative bg-white dark:bg-stone-800 rounded-xl p-6 shadow-sm hover:shadow-md transition-all border border-stone-200 dark:border-stone-700 cursor-pointer flex flex-col justify-between h-48";
            
            // Card visual styling
            card.innerHTML = `
                <div>
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-[10px] uppercase tracking-widest font-bold px-2 py-0.5 rounded" 
                              style="background-color: var(--pill-bg); color: var(--pill-text)">
                            ${item.category}
                        </span>
                        ${item.isBook ? '<i data-lucide="book" class="w-4 h-4 text-stone-400"></i>' : '<i data-lucide="file-text" class="w-4 h-4 text-stone-400"></i>'}
                    </div>
                    <h3 class="font-serif text-lg leading-snug text-stone-900 dark:text-stone-100 group-hover:text-indigo-600 dark:group-hover:text-indigo-400 transition-colors line-clamp-3">
                        ${item.title}
                    </h3>
                </div>
                <div class="flex items-center text-xs text-stone-400 font-sans mt-4">
                    <span class="group-hover:translate-x-1 transition-transform flex items-center gap-1">
                        Read now <i data-lucide="arrow-right" class="w-3 h-3"></i>
                    </span>
                </div>
            `;

            // CSS Variables for dynamic colors
            card.style.setProperty('--pill-bg', document.documentElement.classList.contains('dark') ? colors.dark : colors.light);
            card.style.setProperty('--pill-text', document.documentElement.classList.contains('dark') ? colors.darkText : colors.text);

            card.onclick = () => openReader(item);
            container.appendChild(card);
            lucide.createIcons();
        }

        // --- READER LOGIC ---
        function openReader(item) {
            currentSectionUrl = item.href;
            document.getElementById('reader-title').innerText = item.title;
            switchView('reader');

            if (!rendition) {
                // Init Rendition
                rendition = book.renderTo("viewer", {
                    width: "100%",
                    height: "100%",
                    flow: "paginated",
                    manager: "default",
                    allowScriptedContent: false
                });

                // Hooks
                rendition.on("relocated", function(location){
                    // Update location logic
                    /* Note: Accurate percentage in EPUB.js is tricky without generating locations 
                       which is slow for big books. We'll show chapter info instead.
                    */
                   // Try to find chapter name
                   // const chapter = book.navigation.get(location.start.href);
                   // document.getElementById('page-location').innerText = chapter ? chapter.label : '';
                   document.getElementById('page-location').innerText = "Reading";
                });

                rendition.themes.default({
                    'p': { 'font-family': currentFontFamily, 'font-size': '1.1rem', 'line-height': '1.6' },
                    'h1': { 'font-family': currentFontFamily },
                    'h2': { 'font-family': currentFontFamily }
                });

                applyTheme(currentTheme);
            }

            rendition.display(item.href);
        }

        function nextPage() {
            if(rendition) rendition.next();
        }

        function prevPage() {
            if(rendition) rendition.prev();
        }

        function closeReader() {
            switchView('library');
        }

        // --- SETTINGS & THEMES ---
        function toggleSettings() {
            const el = document.getElementById('settings-popover');
            el.classList.toggle('hidden');
        }

        function changeFontSize(delta) {
            currentFontSize += delta;
            if (rendition) rendition.themes.fontSize(currentFontSize + "%");
            
            // Update UI
            const indicator = document.getElementById('font-size-indicator');
            indicator.style.width = Math.min(Math.max((currentFontSize - 50) / 100 * 100, 0), 100) + '%';
        }

        function changeFontFamily(font) {
            currentFontFamily = font;
            if (rendition) {
                rendition.themes.font(font);
                // Also force paragraph updates
                rendition.themes.default({ 'p': { 'font-family': font }});
            }
        }

        function setReaderTheme(themeName) {
            currentTheme = themeName;
            
            // 1. Set global class for UI (reader wrapper)
            const readerView = document.getElementById('view-reader');
            readerView.className = `absolute inset-0 z-30 flex flex-col ${themeName === 'dark' ? 'bg-stone-950 text-stone-300' : (themeName === 'sepia' ? 'bg-[#f4ecd8] text-[#5b4636]' : 'bg-white text-stone-800')}`;

            // 2. Register and Select epub theme
            // Note: We register new rule objects every time to ensure they apply
            if (rendition) {
                rendition.themes.register(themeName, themes[themeName]);
                rendition.themes.select(themeName);
            }
        }

        function applyTheme(name) {
            setReaderTheme(name);
        }

        // --- VIEW NAVIGATION ---
        function switchView(viewName) {
            const views = ['view-welcome', 'view-library', 'view-reader'];
            views.forEach(v => {
                const el = document.getElementById(v);
                if (v === `view-${viewName}`) {
                    el.classList.remove('hidden');
                    // Small delay to allow display:block to apply before opacity transition
                    setTimeout(() => el.classList.remove('opacity-0'), 10);
                } else {
                    el.classList.add('opacity-0');
                    setTimeout(() => el.classList.add('hidden'), 300);
                }
            });
        }

        function showLoading(show, text = "Loading...") {
            const el = document.getElementById('loading-overlay');
            const txt = document.getElementById('loading-text');
            txt.innerText = text;
            if (show) el.classList.remove('hidden');
            else el.classList.add('hidden');
        }

        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            // Re-render library to fix dynamic colors
            if (libraryData.length > 0) renderLibrary();
        }

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (document.getElementById('view-reader').classList.contains('hidden')) return;
            
            if (e.key === "ArrowRight") nextPage();
            if (e.key === "ArrowLeft") prevPage();
            if (e.key === "Escape") closeReader();
        });

    </script>
</body>
</html>

